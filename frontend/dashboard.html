<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="dashboard">
            <header>
                <div class="header-left">
                    <div class="profile-pic-container">
                        <img id="profilePic" src="https://via.placeholder.com/150" alt="Profile Picture">
                        <button id="changePicBtn" class="icon-btn"><i class="fas fa-camera"></i></button>
                    </div>
                    <h1>Welcome, <span id="userName">User</span></h1>
                </div>
                <button id="logoutBtn" class="btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </header>
            
            <div class="dashboard-content">
                <div class="user-info">
                    <h2><i class="fas fa-user-circle"></i> Your Information</h2>
                    <div id="userDetails">
                        <!-- User details will be populated here -->
                    </div>
                </div>
                
                <div class="location-section">
                    <h2><i class="fas fa-map-marker-alt"></i> Your Location</h2>
                    <div id="map"></div>
                </div>
            </div>
        </div>
    </div>
    <script src="auth.js"></script>
    <script>
        let map, marker, watchId;
        let lastUpdateTime = 0;
        const UPDATE_INTERVAL = 10000; // 10 seconds in milliseconds

        document.addEventListener('DOMContentLoaded', function() {
            if (navigator.geolocation) {
                const options = {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                };
                
                navigator.geolocation.getCurrentPosition(
                    showPosition,
                    handleLocationError,
                    options
                );
            } else {
                alert("Geolocation is not supported by this browser.");
            }

            function showPosition(position) {
                console.log("Received coordinates:", position.coords);
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                const accuracy = Math.min(position.coords.accuracy, 20);

                // Initialize map if not already initialized
                if (!map) {
                    map = L.map('map').setView([lat, lon], 18);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                        attribution: 'Â© OpenStreetMap'
                    }).addTo(map);

                    marker = L.marker([lat, lon]).addTo(map);
                    
                    // Add accuracy circle with limited size
                    L.circle([lat, lon], {
                        radius: accuracy,
                        color: '#3388ff',
                        fillColor: '#3388ff',
                        fillOpacity: 0.2,
                        weight: 2
                    }).addTo(map);
                }

                marker.setLatLng([lat, lon]);
                marker.bindPopup(`You are here (within ${Math.round(accuracy)} meters)`).openPopup();
                map.setView([lat, lon]);

                // Update backend with new coordinates
                updateBackend(lat, lon);

                // Start watching position with high accuracy
                watchId = navigator.geolocation.watchPosition(
                    updatePosition,
                    handleLocationError,
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );

                // Start update timer
                startUpdateTimer();
            }

            function updatePosition(position) {
                const currentTime = Date.now();
                if (currentTime - lastUpdateTime >= UPDATE_INTERVAL) {
                    console.log("Updated coordinates:", position.coords);
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const accuracy = Math.min(position.coords.accuracy, 20);

                    if (map && marker) {
                        marker.setLatLng([lat, lon]);
                        marker.bindPopup(`You are here (within ${Math.round(accuracy)} meters)`).openPopup();
                        map.setView([lat, lon]);
                        
                        // Update backend with new coordinates
                        updateBackend(lat, lon);
                        lastUpdateTime = currentTime;
                    }
                }
            }

            function startUpdateTimer() {
                const timerElement = document.createElement('div');
                timerElement.id = 'updateTimer';
                timerElement.style.position = 'absolute';
                timerElement.style.bottom = '10px';
                timerElement.style.right = '10px';
                timerElement.style.background = 'rgba(0, 0, 0, 0.7)';
                timerElement.style.color = 'white';
                timerElement.style.padding = '5px 10px';
                timerElement.style.borderRadius = '5px';
                timerElement.style.zIndex = '1000';
                document.getElementById('map').appendChild(timerElement);

                let secondsLeft = UPDATE_INTERVAL / 1000;
                timerElement.textContent = `Next update in: ${secondsLeft}s`;

                const timerInterval = setInterval(() => {
                    secondsLeft--;
                    timerElement.textContent = `Next update in: ${secondsLeft}s`;
                    
                    if (secondsLeft <= 0) {
                        secondsLeft = UPDATE_INTERVAL / 1000;
                    }
                }, 1000);
            }

            function handleLocationError(error) {
                let errorMessage;
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = "Location access denied by user.";
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = "Location information unavailable.";
                        break;
                    case error.TIMEOUT:
                        errorMessage = "Location request timed out.";
                        break;
                    default:
                        errorMessage = "An unknown error occurred.";
                }
                console.error("Geolocation error:", errorMessage);
                alert(errorMessage);
            }

            function updateBackend(lat, lon) {
                fetch('/api/me/address', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    body: JSON.stringify({
                        latitude: lat,
                        longitude: lon,
                        street: '',  // Optional fields
                        city: '',
                        state: '',
                        country: '',
                        postal_code: ''
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to update location');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Location updated successfully:', data);
                    // Update the address display in user details
                    const userDetails = document.getElementById('userDetails');
                    if (userDetails) {
                        const addressElement = userDetails.querySelector('p:nth-child(4)');
                        if (addressElement) {
                            const address = data.address;
                            const locationText = address ? 
                                `Lat: ${address.latitude.toFixed(6)}, Lon: ${address.longitude.toFixed(6)}` : 
                                'Location updated';
                            addressElement.innerHTML = `<i class="fas fa-map-marker-alt"></i> <strong>Location:</strong> ${locationText}`;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error updating location:', error);
                });
            }
        });

        // Clean up watchPosition when leaving the page
        window.addEventListener('beforeunload', function() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
        });
    </script>
</body>
</html> 